<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>予約フォーム</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 1em; max-width: 600px; margin: auto; }
    label, input, textarea { display: block; margin-bottom: 10px; width: 100%; }
    .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin: 1em 0 0.5em; }
    .calendar-container { margin-bottom: 10px; }
    .weekdays, .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }
    .weekdays span {
      text-align: center;
      font-weight: bold;
    }
    .calendar button, .calendar .spacer {
      height: 40px;
      font-size: 14px;
      text-align: center;
    }
    .calendar .spacer {
      visibility: hidden;
      border: none;
      background: none;
    }

    .slots {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    .slots button {
      padding: 0.5em 1em;
    }
    .slots button.disabled {
      background: #ccc; color: #666;
      pointer-events: none;
    }

    .selected {
      background-color: orange;
      color: white;
    }

    @media (max-width: 480px) {
      .calendar button, .calendar .spacer, .weekdays span {
        font-size: 12px;
        height: 30px;
      }
    }
  </style>
</head>
<body>
  <h2>予約フォーム</h2>
  <form id="form">
    <label>氏名 <input name="name" required></label>
    <label>電話番号 <input name="phone" required></label>
    <label>メールアドレス <input name="email" type="email" required></label>
    <label>依頼内容 <textarea name="detail" required></textarea></label>

    <div class="calendar-nav">
      <button type="button" id="prevMonth">◀ 前月</button>
      <strong id="calendarTitle"></strong>
      <button type="button" id="nextMonth">次月 ▶</button>
    </div>

    <div class="calendar-container">
      <div class="weekdays">
        <span style="color:red;">日</span>
        <span>月</span>
        <span>火</span>
        <span>水</span>
        <span>木</span>
        <span>金</span>
        <span style="color:blue;">土</span>
      </div>
      <div class="calendar" id="calendar"></div>
    </div>

    <p>選択日：<span id="selected-date-text">未選択</span></p>

    <div>
      <strong>時間を選択</strong>
      <div class="slots" id="slots"></div>
    </div>

    <input type="hidden" name="date" id="date">
    <input type="hidden" name="time" id="time">

    <button type="submit">送信</button>
  </form>
  <p id="msg"></p>

  <script>
    const calendar = document.getElementById('calendar');
    const calendarTitle = document.getElementById('calendarTitle');
    const selectedDateText = document.getElementById('selected-date-text');
    const dateInput = document.getElementById('date');
    const timeInput = document.getElementById('time');
    const slotsDiv = document.getElementById('slots');
    let current = new Date();

    const timeList = [];
    for (let h = 9; h <= 21; h++) timeList.push(`${h}:00`);

    function drawCalendar() {
      const year = current.getFullYear();
      const month = current.getMonth();
      calendar.innerHTML = '';
      calendarTitle.textContent = `${year}年${month + 1}月`;

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      for (let i = 0; i < firstDay; i++) {
        const spacer = document.createElement('div');
        spacer.className = 'spacer';
        calendar.appendChild(spacer);
      }

      for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = d;
        btn.onclick = () => {
          document.querySelectorAll('.calendar button').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          selectedDateText.textContent = dateStr;
          dateInput.value = dateStr;
          loadSlots(dateStr);
        };
        calendar.appendChild(btn);
      }
    }

    function loadSlots(dateStr) {
      google.script.run.withSuccessHandler(available => {
        slotsDiv.innerHTML = '';
        timeList.forEach(t => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = t;
          btn.dataset.time = t;
          if (!available.includes(t)) {
            btn.classList.add('disabled');
            btn.disabled = true;
          }
          btn.onclick = () => {
            timeInput.value = t;
            document.querySelectorAll('.slots button').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
          };
          slotsDiv.appendChild(btn);
        });
      }).getAvailableSlots(dateStr);
    }

    document.getElementById('prevMonth').onclick = () => {
      current.setMonth(current.getMonth() - 1);
      drawCalendar();
    };
    document.getElementById('nextMonth').onclick = () => {
      current.setMonth(current.getMonth() + 1);
      drawCalendar();
    };

    document.getElementById('form').addEventListener('submit', e => {
      e.preventDefault();
      if (!dateInput.value || !timeInput.value) {
        alert('日付と時間を選択してください');
        return;
      }
      const form = Object.fromEntries(new FormData(e.target).entries());
      google.script.run.withSuccessHandler(res => {
        document.getElementById('msg').textContent = res;
        if (res === '予約が完了しました') {
          e.target.reset();
          dateInput.value = '';
          timeInput.value = '';
          selectedDateText.textContent = '未選択';
          drawCalendar();
          slotsDiv.innerHTML = '';
        }
      }).submitReservation(form);
    });

    drawCalendar();
  </script>
</body>
</html>
