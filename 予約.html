<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>予約フォーム</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 1em; background: #f7f7f7; }
    main { max-width: 600px; margin: auto; background: #fff; padding: 1em; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    label { display: block; margin-top: 1em; }
    input, textarea { width: 100%; padding: 0.5em; margin-top: 0.3em; }
    button { margin-top: 1em; width: 100%; padding: 1em; background: #4CAF50; color: white; border: none; border-radius: 5px; }
    .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.3em; margin-top: 1em; text-align: center; }
    .day { padding: 0.5em; cursor: pointer; border-radius: 5px; }
    .day:hover { background: #ddd; }
    .selected-date { background: #ffcc00 !important; }
    .sun { color: red; }
    .sat { color: blue; }
    .timeslot { display: inline-block; padding: 0.5em; margin: 0.2em; border: 1px solid #aaa; border-radius: 5px; cursor: pointer; }
    .timeslot.unavailable { display: none; }
    .timeslot.selected { background: #ffcc00; }
  </style>
</head>
<body>
  <main>
    <h1>予約フォーム</h1>
    <form id="reservation-form">
      <label>氏名<input type="text" name="name" required></label>
      <label>電話番号<input type="tel" name="phone" required></label>
      <label>メールアドレス<input type="email" name="email" required></label>
      <label>依頼内容<textarea name="details" required></textarea></label>

      <div id="calendar" class="calendar"></div>
      <div id="timeslots"></div>

      <button type="submit">予約する</button>
    </form>
    <p id="status"></p>
  </main>

  <script>
    const calendarEl = document.getElementById("calendar");
    const timeslotsEl = document.getElementById("timeslots");
    const statusEl = document.getElementById("status");
    let selectedDate = null;
    let selectedTime = null;
    let reserved = {};

    const holidays = ["2025-01-01", "2025-05-03", "2025-12-23"]; // 例

    function renderCalendar(monthOffset = 0) {
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth() + monthOffset;
      const date = new Date(year, month, 1);

      calendarEl.innerHTML = "";

      const weekdayNames = ["日", "月", "火", "水", "木", "金", "土"];
      for (let i = 0; i < 7; i++) {
        const div = document.createElement("div");
        div.innerHTML = weekdayNames[i];
        calendarEl.appendChild(div);
      }

      for (let i = 0; i < date.getDay(); i++) {
        const empty = document.createElement("div");
        calendarEl.appendChild(empty);
      }

      while (date.getMonth() === month % 12) {
        const dayDiv = document.createElement("div");
        const ymd = date.toISOString().slice(0, 10);
        dayDiv.textContent = date.getDate();
        dayDiv.className = "day";

        if (date.getDay() === 0) dayDiv.classList.add("sun");
        if (date.getDay() === 6) dayDiv.classList.add("sat");
        if (holidays.includes(ymd)) dayDiv.classList.add("sun");

        dayDiv.onclick = () => {
          selectedDate = ymd;
          document.querySelectorAll(".day").forEach(d => d.classList.remove("selected-date"));
          dayDiv.classList.add("selected-date");
          renderTimeSlots();
        };

        calendarEl.appendChild(dayDiv);
        date.setDate(date.getDate() + 1);
      }
    }

    function renderTimeSlots() {
      timeslotsEl.innerHTML = "";
      if (!selectedDate) return;

      for (let hour = 9; hour <= 21; hour++) {
        const timeStr = `${hour}:00`;
        const key = `${selectedDate} ${timeStr}`;
        const div = document.createElement("div");
        div.textContent = timeStr;
        div.className = "timeslot";

        if (reserved[key]) {
          div.classList.add("unavailable");
        } else {
          div.onclick = () => {
            selectedTime = timeStr;
            document.querySelectorAll(".timeslot").forEach(t => t.classList.remove("selected"));
            div.classList.add("selected");
          };
        }

        timeslotsEl.appendChild(div);
      }
    }

    document.getElementById("reservation-form").onsubmit = async (e) => {
      e.preventDefault();
      const form = e.target;
      if (!selectedDate || !selectedTime) {
        alert("日付と時間を選択してください");
        return;
      }

      const name = form.name.value;
      const phone = form.phone.value;
      const email = form.email.value;
      const details = form.details.value;
      const key = `${selectedDate} ${selectedTime}`;

      // ここで重複予約チェック＆登録処理
      if (Object.values(reserved).some(r => r.email === email)) {
        alert("すでに予約が存在します。");
        return;
      }

      reserved[key] = { name, phone, email, details };
      alert("予約が完了しました。確認メールを送信します。");
      renderTimeSlots();
      form.reset();
    };

    renderCalendar();
  </script>
</body>
</html>
